// Global process configuration
process {
    executor = 'awsbatch'
    queueSize = 100
    maxForks = 16          
    errorStrategy = 'retry'       
    maxRetries = 20  
    maxErrors = 100
    
    // Add global retry conditions for better resilience
    errorStrategy = { task.exitStatus in [130,143,137,104,134,139,140] ? 'retry' : 'finish' }
}

// Resource labels for cost tracking
process.resourceLabels = ['allen-batch-pipeline': 'aind-pophys-pipeline']

// Process-specific configurations
process {
    withName: classifier { 
        containerOptions = '--shm-size 4000'
        // Classifier often needs more memory and retries due to GPU issues
        memory = { 64.GB * task.attempt }
        maxRetries = 5
    }
    
    withName: movie_qc {
        // movie_qc generates large files, optimize for publishing
        publishDir = [
            mode: 'copy',
            overwrite: true,
            failOnError: false,
            saveAs: { filename -> filename },
            // Add stageInMode for better file handling
            stageInMode = 'copy'
        ]
    }

}