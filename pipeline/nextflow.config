process {
    executor = 'awsbatch'
    queueSize = 100
    maxForks = 16          
    errorStrategy = 'retry'       
    maxRetries = 20  
    maxErrors = 100
}
process.resourceLabels = ['allen-batch-pipeline': 'aind-pophys-pipeline']
process {
  withName: classifier { containerOptions = '--shm-size 4000' }
}

// Enable detailed publishing logs and execution tracking
trace {
    enabled = true
    file = 'pipeline_trace.txt'
    fields = 'task_id,hash,name,status,exit,submit,start,complete,duration,realtime,queue,cpus,memory,workdir,attempt'
}

// Capture detailed timeline information
timeline {
    enabled = true
    file = 'pipeline_timeline.html'
}

// Generate execution report with publishing details
report {
    enabled = true
    file = 'pipeline_report.html'
}

// AWS S3 publishing configuration for better error handling
aws {
    client {
        // Enhanced retry configuration for S3 operations
        maxRetries = 5
        retryDelayMs = 2000
        uploadChunkSize = '100MB'
        uploadMaxThreads = 4
        // Additional S3 client settings for better reliability
        connectionTimeout = 60000
        socketTimeout = 60000
    }
}

// Process-specific publishing settings
process {
    // Default publishing configuration for all processes
    publishDir = [
        mode: 'copy',
        overwrite: true,
        failOnError: false,
        pattern: '*'
    ]
}